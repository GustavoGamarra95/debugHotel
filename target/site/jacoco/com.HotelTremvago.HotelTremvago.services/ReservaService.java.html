<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReservaService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HotelTremvago</a> &gt; <a href="index.source.html" class="el_package">com.HotelTremvago.HotelTremvago.services</a> &gt; <span class="el_source">ReservaService.java</span></div><h1>ReservaService.java</h1><pre class="source lang-java linenums">package com.HotelTremvago.HotelTremvago.services;

import com.HotelTremvago.HotelTremvago.entities.*;
import com.HotelTremvago.HotelTremvago.repositories.HospedeRepository;
import com.HotelTremvago.HotelTremvago.repositories.QuartoRepository;
import com.HotelTremvago.HotelTremvago.repositories.ReservaRepository;
import com.HotelTremvago.HotelTremvago.repositories.TipoQuartoRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.ZoneId;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.stream.Collectors;

@Service
<span class="fc" id="L18">public class ReservaService {</span>
    @Autowired
    private ReservaRepository reservaRepository;
    @Autowired
    private HospedeRepository hospedeRepository;
    @Autowired
    private TipoQuartoRepository tipoQuartoRepository;
    @Autowired
    private QuartoRepository quartoRepository;

    public Double calcularDiaria(ReservaEntity reservaEntity) {
<span class="fc" id="L29">        long idQuarto = reservaEntity.getQuarto().getId();</span>
<span class="fc" id="L30">        Optional&lt;QuartoEntity&gt; quartoEntity = quartoRepository.findById(idQuarto);</span>

<span class="fc" id="L32">        TipoQuartoEntity tipoQuartoEntity = quartoEntity.get().getTipoQuarto();</span>

<span class="fc" id="L34">        LocalDate dataInicio = reservaEntity.getDataInicio().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>
<span class="fc" id="L35">        LocalDate dataFinal = reservaEntity.getDataFinal().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>

<span class="fc" id="L37">        long dias = ChronoUnit.DAYS.between(dataInicio, dataFinal);</span>
<span class="fc" id="L38">        Double diaria = tipoQuartoEntity.getValor();</span>

<span class="fc" id="L40">        return dias * diaria;</span>
    }


    public List&lt;Integer&gt; datasLivres(Long tipoQuartoId, int capacidade, int mes, int ano) {
<span class="nc" id="L45">        LocalDate inicioMes = LocalDate.of(ano, mes, 1);</span>
<span class="nc" id="L46">        LocalDate fimMes = inicioMes.withDayOfMonth(inicioMes.lengthOfMonth());</span>

<span class="nc" id="L48">        List&lt;Integer&gt; diasMes = inicioMes.datesUntil(fimMes.plusDays(1))</span>
<span class="nc" id="L49">                .map(LocalDate::getDayOfMonth)</span>
<span class="nc" id="L50">                .collect(Collectors.toList());</span>

<span class="nc" id="L52">        List&lt;ReservaEntity&gt; reservasFiltradas = reservaRepository.findByTipoQuartoCapacidadeStatusData(tipoQuartoId, capacidade, java.sql.Date.valueOf(inicioMes), java.sql.Date.valueOf(fimMes));</span>

<span class="nc" id="L54">        List&lt;Integer&gt; diasReservados = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        for (ReservaEntity reserva : reservasFiltradas) {</span>
<span class="nc" id="L56">            LocalDate inicioData = reserva.getDataInicio().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>
<span class="nc" id="L57">            LocalDate fimData = reserva.getDataFinal().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>

<span class="nc bnc" id="L59" title="All 2 branches missed.">            LocalDate inicioIntervalo = inicioData.isBefore(inicioMes) ? inicioMes : inicioData;</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            LocalDate fimIntervalo = fimData.isAfter(fimMes) ? fimMes : fimData;</span>

<span class="nc" id="L62">            LocalDate tempDate = inicioIntervalo;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            while (!tempDate.isAfter(fimIntervalo)) {</span>
<span class="nc bnc" id="L64" title="All 4 branches missed.">                if (tempDate.getMonthValue() == mes &amp;&amp; tempDate.getYear() == ano) {</span>
<span class="nc" id="L65">                    diasReservados.add(tempDate.getDayOfMonth());</span>
                }
<span class="nc" id="L67">                tempDate = tempDate.plusDays(1);</span>
            }
<span class="nc" id="L69">        } LocalDate hoje = LocalDate.now();</span>


<span class="nc" id="L72">        List&lt;QuartoEntity&gt; quartosDisponiveis = quartoRepository.findByTipoQuartoECapacidade(tipoQuartoId, capacidade);</span>

<span class="nc" id="L74">        List&lt;Integer&gt; diasLivres = new ArrayList&lt;&gt;(diasMes);</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">        for (Integer dia : diasMes) {</span>
<span class="nc" id="L77">            LocalDate dataAtual = LocalDate.of(ano, mes, dia);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (diasReservados.contains(dia)) {</span>
<span class="nc" id="L79">                boolean quartoDisponivel = quartosDisponiveis.stream().anyMatch(quarto -&gt; {</span>

<span class="nc" id="L81">                    boolean reservado = reservasFiltradas.stream().anyMatch(reserva -&gt; {</span>
<span class="nc" id="L82">                        LocalDate inicioData = reserva.getDataInicio().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>
<span class="nc" id="L83">                        LocalDate fimData = reserva.getDataFinal().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                        return reserva.getQuarto().getId().equals(quarto.getId()) &amp;&amp;</span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">                                (dataAtual.isAfter(inicioData.minusDays(1)) &amp;&amp; dataAtual.isBefore(fimData.plusDays(1)));</span>
                    });
<span class="nc bnc" id="L87" title="All 2 branches missed.">                    return !reservado;</span>
                });
<span class="nc bnc" id="L89" title="All 2 branches missed.">                if (!quartoDisponivel) {</span>
<span class="nc" id="L90">                    diasLivres.remove(dia);</span>
                }
            }
<span class="nc" id="L93">        }</span>

<span class="nc" id="L95">        List&lt;Integer&gt; datasLivres = diasLivres.stream()</span>
<span class="nc" id="L96">                .filter(dia -&gt; LocalDate.of(ano, mes, dia).isAfter(hoje))</span>
<span class="nc" id="L97">                .collect(Collectors.toList());</span>

<span class="nc" id="L99">        return datasLivres;</span>
    }


    public ReservaEntity save(ReservaEntity reservaEntity) {
        try {
<span class="fc" id="L105">            Double preco = calcularDiaria(reservaEntity);</span>
<span class="fc" id="L106">            reservaEntity.setTotal(preco);</span>
<span class="fc" id="L107">            return reservaRepository.save(reservaEntity);</span>
<span class="fc" id="L108">        } catch (Exception e) {</span>
<span class="fc" id="L109">            System.out.println(&quot;Nao foi possivel salvar reserva: &quot; + e.getMessage());</span>
<span class="fc" id="L110">            return new ReservaEntity();</span>
        }
    }

    public String delete(Long id){
        try {
<span class="fc" id="L116">            reservaRepository.deleteById(id);</span>
<span class="fc" id="L117">            return &quot;Reserva deletado&quot;;</span>
<span class="fc" id="L118">        } catch (Exception e){</span>
<span class="fc" id="L119">            return &quot;Nao foi possivel deletar reserva&quot;;</span>
        }
    }

    public ReservaEntity update(ReservaEntity reservaEntity, Long id){
        try{
<span class="fc" id="L125">            reservaEntity.setId(id);</span>
<span class="fc" id="L126">            return reservaRepository.save(reservaEntity);</span>
<span class="nc" id="L127">        } catch(Exception e){</span>
<span class="nc" id="L128">            System.out.println(&quot;Nao foi possivel atualizar reserva: &quot; + e.getMessage());</span>
<span class="nc" id="L129">            return new ReservaEntity();</span>
        }
    }

    public ReservaEntity findById(Long id){
        try{
<span class="fc" id="L135">            return reservaRepository.findById(id).orElseThrow();</span>
<span class="nc" id="L136">        }catch(Exception e){</span>
<span class="nc" id="L137">            System.out.println(&quot;Nao foi possivel encontrar uma reserva com este ID: &quot; + e.getMessage());</span>
<span class="nc" id="L138">            return new ReservaEntity();</span>
        }
    }

    public List&lt;ReservaEntity&gt; findAll() {
        try{
<span class="fc" id="L144">            return reservaRepository.findAll();</span>
<span class="nc" id="L145">        } catch(Exception e) {</span>
<span class="nc" id="L146">            System.out.println(&quot;Erro ao encontrar lista de reserva: &quot; + e.getMessage());</span>
<span class="nc" id="L147">            return Collections.emptyList();</span>
        }
    }
    public ReservaEntity addHospedeToReserva(Long reservaId, Long hospedeId) {
        try {
<span class="pc" id="L152">            ReservaEntity reserva = reservaRepository.findById(reservaId).orElseThrow(() -&gt; new RuntimeException(&quot;Reserva não encontrada&quot;));</span>
<span class="pc" id="L153">            HospedeEntity hospede = hospedeRepository.findById(hospedeId).orElseThrow(() -&gt; new RuntimeException(&quot;Hospede não encontrado&quot;));</span>

<span class="fc" id="L155">            reserva.getHospedes().add(hospede);</span>
<span class="fc" id="L156">            hospede.getReservas().add(reserva);</span>

<span class="fc" id="L158">            reservaRepository.save(reserva);</span>
<span class="fc" id="L159">            hospedeRepository.save(hospede);</span>

<span class="fc" id="L161">            return reserva;</span>
<span class="nc" id="L162">        } catch (Exception e) {</span>
<span class="nc" id="L163">            System.out.println(&quot;Não foi possível adicionar o hóspede à reserva: &quot; + e.getMessage());</span>
<span class="nc" id="L164">            return null;</span>
        }
    }
    public ReservaEntity removeHospedeFromReserva(Long reservaId, Long hospedeId) {
        try {
<span class="fc" id="L169">            ReservaEntity reserva = reservaRepository.findById(reservaId)</span>
<span class="pc" id="L170">                    .orElseThrow(() -&gt; new RuntimeException(&quot;Reserva não encontrada&quot;));</span>
<span class="fc" id="L171">            HospedeEntity hospede = hospedeRepository.findById(hospedeId)</span>
<span class="pc" id="L172">                    .orElseThrow(() -&gt; new RuntimeException(&quot;Hospede não encontrado&quot;));</span>

<span class="fc" id="L174">            reserva.getHospedes().remove(hospede);</span>
<span class="fc" id="L175">            hospede.getReservas().remove(reserva);</span>

<span class="fc" id="L177">            reservaRepository.save(reserva);</span>
<span class="fc" id="L178">            hospedeRepository.save(hospede);</span>

<span class="fc" id="L180">            return reserva;</span>
<span class="nc" id="L181">        } catch (Exception e) {</span>
<span class="nc" id="L182">            System.out.println(&quot;Não foi possível remover o hóspede da reserva: &quot; + e.getMessage());</span>
<span class="nc" id="L183">            return null;</span>
        }
    }

    public ReservaEntity realizarCheckIn(Long id) {
<span class="fc" id="L188">        ReservaEntity reserva = reservaRepository.findById(id)</span>
<span class="pc" id="L189">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Reserva não encontrada&quot;));</span>

<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (reserva.getStatus() == ReservaStatus.CANCELADO) {</span>
<span class="fc" id="L192">            throw new IllegalStateException(&quot;Não é possível fazer check-in em uma reserva cancelada&quot;);</span>
        }

<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (reserva.getStatus() != ReservaStatus.RESERVADO) {</span>
<span class="nc" id="L196">            throw new IllegalStateException(&quot;Apenas reservas com status RESERVADO podem ser check-in&quot;);</span>
        }

<span class="fc" id="L199">        reserva.setStatus(ReservaStatus.OCUPADO);</span>
<span class="fc" id="L200">        reserva.setDataCheckIn(new Date());</span>

<span class="fc" id="L202">        return reservaRepository.save(reserva);</span>
    }
    public ReservaEntity realizarCheckOut(Long id) {
<span class="fc" id="L205">        ReservaEntity reserva = reservaRepository.findById(id)</span>
<span class="pc" id="L206">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Reserva não encontrada&quot;));</span>

<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (reserva.getStatus() == ReservaStatus.CANCELADO) {</span>
<span class="nc" id="L209">            throw new IllegalStateException(&quot;Não é possível fazer check-out em uma reserva cancelada&quot;);</span>
        }

<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (reserva.getStatus() != ReservaStatus.OCUPADO) {</span>
<span class="fc" id="L213">            throw new IllegalStateException(&quot;Apenas reservas com status OCUPADO podem ser check-out&quot;);</span>
        }

<span class="fc" id="L216">        reserva.setStatus(ReservaStatus.RESERVADO);</span>
<span class="fc" id="L217">        reserva.setDataCheckOut(new Date());</span>

<span class="fc" id="L219">        return reservaRepository.save(reserva);</span>
    }
}



</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>